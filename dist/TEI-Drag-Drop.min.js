/*
 *  tei-drag-drop - v0.1.0
 *  jQuery plugin to order words on a grid and generate xml output
 *  https://github.com/PonteIneptique/TEI-Drag-Drop
 *
 *  Made by Thibault Cl√©rice
 *  Under GNU GPL License
 */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){var b={GetXML:"Get XML",ToggleXML:"Show / Hide XML",UpdateLines:"Update Lines",Lines:"Lines"},c=function(a){return c="function"==typeof Array.prototype.indexOf?Array.prototype.indexOf:function(a){var b=-1,c=-1;for(b=0;b<this.length;b++)if(this[b]===a){c=b;break}return c},c.call(this,a)};a.fn.teidragdrop=function(d){var e=this,f=[],g=null,h=null,i=[],j={watch:!0,line:"<l />",toolbar:["Serialize","ToggleXML"],linegroup:"<lg />",linebreak:"<lb />","grid-selector":null,rows:4,widthHeightRatio:2,"btn.class":"btn","btn.legend":"Serialize",btn:null,startline:1,pre:!0,linestool:!0},k=function(){var c=a("<div />",{"class":"teidragdrop-toolbar"});if(j.toolbar.length>0){var d=a("<pre />",{style:"width:90%;"}),e=a("<button />",{"class":"btn btn-default",type:"button",text:b.GetXML});e.on("click",function(){d.text(w())});var f=a("<button />",{"class":"btn btn-default",type:"button",text:b.ToggleXML});f.on("click",function(){d.toggle()});for(var h={Serialize:e,ToggleXML:f},i=a("<div />",{"class":"btn-group"}),k=0;k<j.toolbar.length;k++)i.append(h[j.toolbar[k]]);c.append(i),c.append(a("<div />").append(d))}if(j.linestool){var m=a("<div />",{"class":"input-group",style:"width:200px; float:left; margin-right:10px;"}),n=a("<span />",{"class":"input-group-addon",text:b.UpdateLines}),o=a("<input />",{"class":"form-control",type:"text",value:j.rows,placeholder:b.Lines});o.on("change",function(){l(o.val())}),n.on("click",function(){l(o.val())}),m.append(n,o),c.append(m)}g.after(c)},l=function(a){if(!isNaN(a)){j.rows=parseInt(a);var b=s();"undefined"!=typeof b&&b.resize(j.rows)}},m=function(b){var c,d,e=a("<div />").append(b).html(),f=0,g=e.length;if(0===g)return f;for(c=0;g>c;c++)d=e.charCodeAt(c),f=(f<<5)-f+d,f&=f;return f},n=function(){var b=[];return a.each(a(e.val()),function(a,d){var e=m(d);3!==d.nodeType&&-1===c.call(i,e)&&(b.push(d),i.push(e))}),b},o=function(b){a.each(b,function(a,b){p(a,b)})},p=function(b,c){var d=a("<li />"),e=a("<div />").html(c),f=z(h.find("li").length+1);d.data("xml-representation",e.html()),d.append(a("<div />",{"class":"inner"}).text(e.text())),d.attr("data-w",1),d.attr("data-h",1),d.attr("data-x",f[0]),d.attr("data-y",f[1]),h.append(d)},q=function(){0===g.find("ul").length&&g.append("<ul></ul>"),h=g.find("ul"),o(f),r()},r=function(){h.gridList({rows:j.rows,widthHeightRatio:j.widthHeightRatio})},s=function(){return h.data("_gridList")},t=function(){a.each(s()._items,function(a,b){b.$element.attr("data-x",b.x),b.$element.attr("data-y",b.y)})},u=function(){"undefined"!=typeof s()._items&&t(),h.data("_gridList",!1),r()},v=function(){o(n()),u()},w=function(){var b=h.data("_gridList")._items,c={};return a.each(b,function(a,b){"undefined"==typeof c[b.y]&&(c[b.y]={}),c[b.y][b.x]=b.$element.data("xml-representation")}),y(x(c))},x=function(b){for(var c=[],d=0;d<Object.keys(b).length;d++)c.push("");return a.each(b,function(a,b){null!==b&&"object"==typeof b&&(b=x(b)),c[parseInt(a)]=b}),c},y=function(b){for(var c=[],d=0;d<b.length;d++){var e=a(j.line),f=d+j.startline;e.attr("n",f),j.linebreak&&b[d].push(a("<div />").html(a(j.linebreak).attr("n",f)).html()),e.html("\n	"+b[d].join("\n	")+"\n"),c.push(a("<div />").html(e).html())}return c.join("\n")},z=function(b){if("undefined"==typeof h||"undefined"==typeof h.data("_gridList")||"undefined"==typeof h.data("_gridList")._items)return"number"==typeof b?[b-1,0]:!1;var c=h.data("_gridList")._items,d={},e=0,f=0;return a.each(c,function(a,b){"undefined"==typeof d[b.y]&&(d[b.y]={}),d[b.y][b.x]=b.$element.data("xml-representation")}),d=x(d),f=d.length,e=d[f-1].length,[e,f-1]};if(f=n(),a.extend(j,d),null!=j["grid-selector"])g=a(j["grid-selector"]);else{for(instanceNumber=0;0!==a(".teidragdrop-container"+instanceNumber).length;)instanceNumber++;g=a("<div />",{"class":"teidragdrop-container teidragdrop-container"+instanceNumber}),e.after(g)}return j.watch===!0&&e.on("change",function(){v()}),j.btn&&j.btn.on("click",function(){console.log(w())}),q(),j.toolbar.length>0&&(console.log("Initiating ToolBar"),k()),e.is("textarea")||console.log("Element on which instance is built is not a textarea."),this.reload=u,this}});