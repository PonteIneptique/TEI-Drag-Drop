/*
 *  tei-drag-drop - v0.1.0
 *  jQuery plugin to order words on a grid and generate xml output
 *  https://github.com/PonteIneptique/TEI-Drag-Drop
 *
 *  Made by Thibault Cl√©rice
 *  Under GNU GPL License
 */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){function b(b,d){this.element=a(b),this.settings=a.extend({},g,d),this._defaults=g,this._name=f,this.blocks=[],this.container=null,this.grid=null,this.hashes=[],this.lang=c,this.init()}var c={GetXML:"Get XML",ToggleXML:"Show / Hide XML",UpdateLines:"Update Lines",Lines:"Lines"},d=function(a){return d="function"==typeof Array.prototype.indexOf?Array.prototype.indexOf:function(a){var b=-1,c=-1;for(b=0;b<this.length;b++)if(this[b]===a){c=b;break}return c},d.call(this,a)},e=function(b){var c,d,e=a("<div />").append(b).html(),f=0,g=e.length;if(0===g)return f;for(c=0;g>c;c++)d=e.charCodeAt(c),f=(f<<5)-f+d,f&=f;return f},f="TeiDragDrop",g={watch:!0,line:"<l />",toolbar:["Serialize","ToggleXML"],linegroup:"<lg />",linebreak:"<lb />","grid-selector":null,rows:4,widthHeightRatio:2,startline:1,pre:!0,linestool:!0,rowHeight:50,hierarchical:!1,blocksWidth:1};a.extend(b.prototype,{init:function(){if(this.blocks=this.returnNodes(),null!==this.settings["grid-selector"])this.container=a(this.settings["grid-selector"]),this.container.addClass("teidragdrop-container");else{for(instanceNumber=0;0!==a(".teidragdrop-container"+instanceNumber).length;)instanceNumber++;this.container=a("<div />",{"class":"teidragdrop-container teidragdrop-container"+instanceNumber}),this.element.after(this.container)}this.settings.watch===!0&&(self=this,this.element.on("change",function(){self.changed()})),this.initiateGrid(),this.settings.toolbar.length>0&&(console.log("Initiating ToolBar"),this.toolbarGeneration())},toolbarGeneration:function(){var b,c=this,d=a("<div />",{"class":"teidragdrop-toolbar"});if(this.settings.toolbar.length>0){b=a("<pre />",{style:"width:90%;"});var e=a("<button />",{"class":"btn btn-default",type:"button",text:c.lang.GetXML}),f=a("<button />",{"class":"btn btn-default",type:"button",text:c.lang.ToggleXML});e.on("click",function(){b.text(c.serialize())}),f.on("click",function(){b.toggle()});for(var g={Serialize:e,ToggleXML:f},h=a("<div />",{"class":"btn-group"}),i=0;i<this.settings.toolbar.length;i++)h.append(g[this.settings.toolbar[i]]);d.append(h)}if(this.settings.linestool){var j=a("<div />",{"class":"input-group",style:"width:200px; float:left; margin-right:10px;"}),k=a("<span />",{"class":"input-group-addon",text:this.lang.UpdateLines}),l=a("<input />",{"class":"form-control",type:"text",value:this.settings.rows,placeholder:this.lang.Lines});l.on("change",function(){c.upgradeLines(l.val())}),k.on("click",function(){c.upgradeLines(l.val())}),j.append(k,l),d.append(j)}"undefined"!=typeof b&&d.append(a("<div />").append(b)),this.container.after(d)},upgradeLines:function(a){if(!isNaN(a)){this.settings.rows=parseInt(a);var b=this.getInstance();"undefined"!=typeof b&&b.resize(this.settings.rows)}},returnNodes:function(){var b=this.hashes,c=[];return a.each(a(this.element.val()),function(a,f){var g=e(f);3!==f.nodeType&&-1===d.call(b,g)&&(c.push(f),b.push(g))}),this.hashes=b,c},addBlock:function(b,c){var d=a("<li />"),e=a("<div />").html(c),f=this.lastItem(this.grid.children("li").length+1),g=a("<div />",{"class":"inner"});if(d.data("xml-representation",e.html()),this.settings.hierarchical){d.attr("data-h",a(c).find("*").length),d.append();var h=a("<ul />",{"class":"list-unstyled inner"});a(c).find("*").each(function(b,c){h.append(a("<li />",{text:a(c).text()}))}),g.append(h)}else d.attr("data-h",1),g.text(e.text());d.attr("data-w",this.settings.blocksWidth),d.attr("data-x",f[0]),d.attr("data-y",f[1]),d.append(g),this.grid.append(d)},addBlocks:function(b){var c=this;a.each(b,function(a,b){c.addBlock(a,b)})},initiateGrid:function(){0===this.container.find("ul").length&&this.container.append(a("<ul />").css("width","100%").css("height",this.settings.rowHeight*this.settings.rows)),this.grid=this.container.find("ul"),this.addBlocks(this.blocks),this.createGrid()},createGrid:function(){this.grid.gridList({rows:this.settings.rows,widthHeightRatio:this.settings.widthHeightRatio})},getInstance:function(){return this.grid.data("_gridList")},applyXY:function(){a.each(this.getInstance()._items,function(a,b){b.$element.attr("data-x",b.x),b.$element.attr("data-y",b.y)})},reload:function(){"undefined"!=typeof this.getInstance()._items&&this.applyXY(),this.grid.data("_gridList",!1),this.createGrid()},changed:function(){this.addBlocks(this.returnNodes()),this.reload()},serialize:function(){for(var b=this.getInstance()._items,c={},d=this.settings.rows-1;d>=0;d--)c[d]={};return a.each(b,function(a,b){"undefined"==typeof c[b.y]&&(c[b.y]={}),c[b.y][b.x]=b.$element.data("xml-representation")}),this.toXML(this.toArray(c))},toArray:function(b){for(var c=[],d=this,e=0;e<Object.keys(b).length;e++)c.push("");return a.each(b,function(a,b){null!==b&&"object"==typeof b&&(b=d.toArray(b)),c[parseInt(a)]=b}),c},toXML:function(b){for(var c=[],d=0;d<b.length;d++){var e=a(this.settings.line),f=d+this.settings.startline;e.attr("n",f),this.settings.linebreak&&b[d].push(a("<div />").html(a(this.settings.linebreak).attr("n",f)).html()),e.html("\n	"+b[d].join("\n	")+"\n"),c.push(a("<div />").html(e).html())}return c.join("\n")},lastItem:function(b){var c;if("undefined"==typeof this.grid||"undefined"==typeof this.getInstance()||"undefined"==typeof this.getInstance()._items)return"number"==typeof b?(c=1===b?b-1:(b-1)*this.settings.blocksWidth,[c,0]):!1;var d=this.getInstance()._items,e={},f=0;return c=0,a.each(d,function(a,b){"undefined"==typeof e[b.y]&&(e[b.y]={}),e[b.y][b.x]=b.$element.data("xml-representation")}),e=_toArray(e),f=e.length,c=e[f-1].length,[c,f-1]}}),a.fn.teidragdrop=function(c){var d=arguments;if(!window.GridList)throw new Error("GridList lib required");if(void 0===c||"object"==typeof c)return this.each(function(){a.data(this,"_teidragdrop")||a.data(this,"_teidragdrop",new b(this,c))});if("string"==typeof c&&"_"!==c[0]&&"init"!==c){var e;return this.each(function(){var f=a.data(this,"_teidragdrop");f instanceof b&&"function"==typeof f[c]&&(e=f[c].apply(f,Array.prototype.slice.call(d,1))),"destroy"===c&&a.data(this,"_teidragdrop",null)}),void 0!==e?e:this}}});